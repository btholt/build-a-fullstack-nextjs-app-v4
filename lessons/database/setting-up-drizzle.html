<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Setting up Drizzle – Build a Fullstack Next.js App, v4</title><meta name="description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="keywords" content="Next.js,fullstack,React,TypeScript,authentication,database,Postgres,Vercel,deployment,SaaS,AI integration,modern web development" data-next-head=""/><meta name="og:description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="og:title" content="Setting up Drizzle – Build a Fullstack Next.js App, v4" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/de2ef606dd4d4a67.css" as="style"/><link rel="stylesheet" href="/_next/static/css/de2ef606dd4d4a67.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b66ed8ba6f029a99.js" defer=""></script><script src="/_next/static/chunks/framework-b1e5f14688f9ffe6.js" defer=""></script><script src="/_next/static/chunks/main-953f8078176d6f7b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-04cfcdd17f247960.js" defer=""></script><script src="/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-e3f3acd10ab352ae.js" defer=""></script><script src="/_next/static/XOcKuB9gZ84DgFGtHvLgN/_buildManifest.js" defer=""></script><script src="/_next/static/XOcKuB9gZ84DgFGtHvLgN/_ssgManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Build a Fullstack Next.js App, v4</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/fullstack-app-next-v4/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>We are going to get started writing to our database using Drizzle. Drizzle is a phenomenal ORM, which stands for object-relational mapping. In reality it just means a it&#39;s a software package where you define the shape of your data, and it takes care of managing and querying the database for you. Instead of writing raw SQL statements, you write code that then gets translated into SQL for you.</p>
<p>In the past I did not recommend using an ORM (I think you can find this in my previous Frontend Masters courses!) Why not? I had some pretty bad experiences over the year using ORMs in the earlier days of my career (mostly in PHP and Java.) I&#39;d start using an ORM and it would be amazing: it made it easy to get started, to do basic selects and inserts, and the general 95% use case (and I&#39;ll say generally speaking, writing this sort of SQL is not hard.) The problem came when you needed to do more advanced querying that the designers of the ORM didn&#39;t anticipate. All the sudden what was helping you work faster was a huge impedance on you doing what you want to do. You&#39;re suddenly fighting the framework instead of being helped by it. This happened frequently enough that I decided I&#39;d rather just write SQL, and I did that for most of my career (I also like SQL, but it took a lot of practice for me to say that.)</p>
<p>So why now? Why do I like Drizzle instead of choosing to just to continue to do raw SQL?</p>
<ul>
<li>Its design is very SQL-ish. A lot of other ORMs try to hide SQL from you and in the process make it hard when you need to do SQL-ish things. that&#39;s probably my biggest complaint about other ORMs and I <em>don&#39;t</em> have that about Drizzle.</li>
<li>TypeScript support, and that&#39;s the biggest reason <em>to</em> use Drizzle. When you describe something in Drizzle, all the sudden you have amazing TypeScript support for all your database queries. Otherwise you&#39;d be stuck writing all these types yourself and with Drizzle you just don&#39;t have to.</li>
<li>They even go one step further and they make little packages for each database provider. For Neon, we have all the Neon Auth tables built into the Drizzle package so you don&#39;t need to write those types; they&#39;re just built into Drizzle. So cool!</li>
<li>The OSS team is also super nice and helpful.</li>
</ul>
<p>So let&#39;s get started! We&#39;re going to need a few packages</p>
<pre><code class="hljs language-bash">npm i drizzle-orm @neondatabase/serverless dotenv
npm i -D drizzle-kit drizzle-seed
</code></pre><ul>
<li>The ORM package is package that you&#39;ll actually use in your codebase.</li>
<li>The drizzle-kit package is all the CLI commands you need to run Drizzle. So creating migrations, running migrations, etc.</li>
<li>We could use the normal pg and postgres.js packages, and in many cases you might want to. These use TCP for their connections and support connection pooling that leave connections open which means lower-latency and generally faster connections. However initial connections for these sorts of packages take a while and really aren&#39;t a good fit for things like serverless environments where connections will be spinning up and spinning down frequently.</li>
<li>We&#39;re going to use the Neon serverless driver. This allows us to do SQL over either HTTP or WebSockets (and we&#39;re going to do HTTP.) Honestly if we were going to scale up this project, we&#39;d probably want to do the TCP drivers as it might make more sense, but I usually get started with the serverless driver and switch when I see it being helpful. Both work really well.</li>
<li>Doing Neon over HTTP is perfectly suited for Vercel&#39;s serverless architecture, but it does carry some performance overhead. If you&#39;re really performance sensitive or doing transactions is really important to you, we&#39;d need to re-architect this to happen over websockets. But we don&#39;t so this works!</li>
<li>We&#39;re also install drizzle-seed which makes seeding your Drizzle database very easy.</li>
</ul>
<p>Okay, let&#39;s start making our database work. Normally you&#39;d need to go to Neon.com and create your project and get your DATABASE_URL and put that in your .env file, but we did that as part of setting up auth. So let&#39;s go ahead and start with our config.</p>
<p>Go create in the root of the project drizzle.config.ts. Put in there</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;dotenv/config&quot;</span>;
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;drizzle-kit&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">out</span>: <span class="hljs-string">&quot;./drizzle&quot;</span>,
  <span class="hljs-attr">schema</span>: <span class="hljs-string">&quot;./src/db/schema.ts&quot;</span>,
  <span class="hljs-attr">dialect</span>: <span class="hljs-string">&quot;postgresql&quot;</span>,
  <span class="hljs-attr">dbCredentials</span>: {
    <span class="hljs-attr">url</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_URL</span>!,
  },
});
</code></pre><p>This is just some basic config for Drizzle, nothing of note.</p>
<p>Now go create src/db as a folder. Put in there schema.ts</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { pgTable, serial, text, timestamp, <span class="hljs-built_in">boolean</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;drizzle-orm/pg-core&quot;</span>;
<span class="hljs-keyword">import</span> { usersSync } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;drizzle-orm/neon&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> articles = <span class="hljs-title function_">pgTable</span>(<span class="hljs-string">&quot;articles&quot;</span>, {
  <span class="hljs-attr">id</span>: <span class="hljs-title function_">serial</span>(<span class="hljs-string">&quot;id&quot;</span>).<span class="hljs-title function_">primaryKey</span>(),
  <span class="hljs-attr">title</span>: <span class="hljs-title function_">text</span>(<span class="hljs-string">&quot;title&quot;</span>).<span class="hljs-title function_">notNull</span>(),
  <span class="hljs-attr">slug</span>: <span class="hljs-title function_">text</span>(<span class="hljs-string">&quot;slug&quot;</span>).<span class="hljs-title function_">notNull</span>().<span class="hljs-title function_">unique</span>(),
  <span class="hljs-attr">content</span>: <span class="hljs-title function_">text</span>(<span class="hljs-string">&quot;content&quot;</span>).<span class="hljs-title function_">notNull</span>(),
  <span class="hljs-attr">imageUrl</span>: <span class="hljs-title function_">text</span>(<span class="hljs-string">&quot;image_url&quot;</span>),
  <span class="hljs-attr">published</span>: <span class="hljs-title function_">boolean</span>(<span class="hljs-string">&quot;published&quot;</span>).<span class="hljs-title function_">default</span>(<span class="hljs-literal">false</span>).<span class="hljs-title function_">notNull</span>(),
  <span class="hljs-attr">authorId</span>: <span class="hljs-title function_">text</span>(<span class="hljs-string">&quot;author_id&quot;</span>)
    .<span class="hljs-title function_">notNull</span>()
    .<span class="hljs-title function_">references</span>(<span class="hljs-function">() =&gt;</span> usersSync.<span class="hljs-property">id</span>),
  <span class="hljs-attr">createdAt</span>: <span class="hljs-title function_">timestamp</span>(<span class="hljs-string">&quot;created_at&quot;</span>, { <span class="hljs-attr">mode</span>: <span class="hljs-string">&quot;string&quot;</span> }).<span class="hljs-title function_">defaultNow</span>().<span class="hljs-title function_">notNull</span>(),
  <span class="hljs-attr">updatedAt</span>: <span class="hljs-title function_">timestamp</span>(<span class="hljs-string">&quot;updated_at&quot;</span>, { <span class="hljs-attr">mode</span>: <span class="hljs-string">&quot;string&quot;</span> }).<span class="hljs-title function_">defaultNow</span>().<span class="hljs-title function_">notNull</span>(),
});

<span class="hljs-keyword">const</span> schema = { articles };
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> schema;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Article</span> = <span class="hljs-keyword">typeof</span> articles.<span class="hljs-property">$inferSelect</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">NewArticle</span> = <span class="hljs-keyword">typeof</span> articles.<span class="hljs-property">$inferInsert</span>;
</code></pre><ul>
<li>While this is a lot of new code for you, if you know SQL it should all look <em>super</em> familiar to you. We&#39;re basically doing <code>CREATE TABLE</code> commands in code. We&#39;re describing what data types we want and what constraints we want (like notNull or unique).</li>
<li>usersSync from the neon portion of the drizzle-orm package describes the users table from Neon Auth. It&#39;s a table that already exists, and we already have all the types and such from Drizzle, made by the Neon and Drizzle team. Pretty cool that it already exists!</li>
<li><code>references</code> sets up a foreign key. That means the authorId references the id key in the usersSync table.</li>
<li>What&#39;s nice is we&#39;re not stuck calling &quot;created_at&quot; using snake case in JavaScript. Drizzle makes it easy for us to define our own alias of what we want to call it in code versus what it&#39;s called in the database. This was particularly helpful in a codebase I was working in where the actual names of the columns were very long and annoying due to being apart of another system but we could call it whatever we wanted in JS code.</li>
<li><code>$inferSelect</code> and <code>$inferInsert</code> are probably two of the coolest black magic features in code I&#39;ve ever used. It takes the database shape that we set up for the articles tables and turns it into a TypeScript type. We write the code once and we get both the TypeScript types and the database ORM to use. Amazing. If you&#39;re writing raw SQL, you need to author and maintain those types yourself.</li>
</ul>
<p>That&#39;s it! Now we have a schema that we can use to create our database connection. Go create an index.ts file in the same directory.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { neon } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@neondatabase/serverless&quot;</span>;
<span class="hljs-keyword">import</span> { drizzle } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;drizzle-orm/neon-http&quot;</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> schema <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/db/schema&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;dotenv/config&quot;</span>;

<span class="hljs-keyword">const</span> sql = <span class="hljs-title function_">neon</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_URL</span>!);
<span class="hljs-keyword">const</span> db = <span class="hljs-title function_">drizzle</span>(sql, { schema });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> db;
</code></pre><p>This is just setting up the ORM to be ready to be used by your code. If you were using the pg or postgres packages, you&#39;d set those up here instead. It&#39;s really easy to swap in the future - no other code needs to change.</p>
<p>Okay, now let&#39;s create our first migration with generate.</p>
<pre><code class="hljs language-bash">npx drizzle-kit generate
</code></pre><p>This actually creates the drizzle directory in the root of your project (check this code in) and spits out some meta data and raw SQL files. Feel free to read these (I like Drizzle because these are usually pretty readable) but never, ever, ever modify these by hands. You are setting yourself up for major issues if you do because Drizzle assumes it does all of these and will not respect any handcrafted code you chuck in here.</p>
<blockquote>
<p>Note that this creates the migrations but does not apply them. Your Neon database will still be empty until you run migrate.</p>
</blockquote>
<p>Now let&#39;s run it.</p>
<pre><code class="hljs language-bash">npx drizzle-kit migrate
</code></pre><p>This applies what we made with generate. And now you can see the empty tables in Neon. Pretty cool, right!?</p>
<blockquote>
<p>You can also run <code>npx drizzle-kit push</code> to just yolo apply whatever schema you have at the moment. This is nice when you&#39;re making changes and you just want to apply the new schema and aren&#39;t ready to codify what you have as code.</p>
</blockquote>
<p>I wrote a little seed script for you to have some database. <strong>Note: you must have at least one user signed up via Neon Auth or this does not work</strong>. Either sign up via your website or add one manually via the Neon console.</p>
<p><a href="https://github.com/btholt/fullstack-next-wiki/tree/main/04-database/src/db/seed.ts">Copy and paste all of this code</a> into db/seed.ts.</p>
<p>Let&#39;s make all of these npm scripts.</p>
<pre><code class="hljs language-json"><span class="hljs-comment">// the end of your scripts in your package.json</span>
<span class="hljs-attr">&quot;db:seed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tsx src/db/seed.ts&quot;</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">&quot;db:generate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;drizzle-kit generate&quot;</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">&quot;db:migrate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;drizzle-kit migrate&quot;</span>
</code></pre><p>We&#39;ll need tsx for this as well (run TypeScript files as Node, just makes it easy) so run <code>npm i -D tsx</code></p>
<p>So feel free to run <code>npm run db:seed</code> now and you should have five articles in your database now to play with.</p>
<p>Awesome. Let&#39;s go <em>use</em> these now.</p>
</div><div class="lesson-links"><a href="/lessons/database/neon-and-postgres" class="prev">← Previous</a><a href="/lessons/database/query-with-drizzle" class="next">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><link id="highlight-theme-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-light.min.css"/><link id="highlight-theme-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-dark.min.css" disabled=""/><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{},"html":"\u003cp\u003eWe are going to get started writing to our database using Drizzle. Drizzle is a phenomenal ORM, which stands for object-relational mapping. In reality it just means a it\u0026#39;s a software package where you define the shape of your data, and it takes care of managing and querying the database for you. Instead of writing raw SQL statements, you write code that then gets translated into SQL for you.\u003c/p\u003e\n\u003cp\u003eIn the past I did not recommend using an ORM (I think you can find this in my previous Frontend Masters courses!) Why not? I had some pretty bad experiences over the year using ORMs in the earlier days of my career (mostly in PHP and Java.) I\u0026#39;d start using an ORM and it would be amazing: it made it easy to get started, to do basic selects and inserts, and the general 95% use case (and I\u0026#39;ll say generally speaking, writing this sort of SQL is not hard.) The problem came when you needed to do more advanced querying that the designers of the ORM didn\u0026#39;t anticipate. All the sudden what was helping you work faster was a huge impedance on you doing what you want to do. You\u0026#39;re suddenly fighting the framework instead of being helped by it. This happened frequently enough that I decided I\u0026#39;d rather just write SQL, and I did that for most of my career (I also like SQL, but it took a lot of practice for me to say that.)\u003c/p\u003e\n\u003cp\u003eSo why now? Why do I like Drizzle instead of choosing to just to continue to do raw SQL?\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIts design is very SQL-ish. A lot of other ORMs try to hide SQL from you and in the process make it hard when you need to do SQL-ish things. that\u0026#39;s probably my biggest complaint about other ORMs and I \u003cem\u003edon\u0026#39;t\u003c/em\u003e have that about Drizzle.\u003c/li\u003e\n\u003cli\u003eTypeScript support, and that\u0026#39;s the biggest reason \u003cem\u003eto\u003c/em\u003e use Drizzle. When you describe something in Drizzle, all the sudden you have amazing TypeScript support for all your database queries. Otherwise you\u0026#39;d be stuck writing all these types yourself and with Drizzle you just don\u0026#39;t have to.\u003c/li\u003e\n\u003cli\u003eThey even go one step further and they make little packages for each database provider. For Neon, we have all the Neon Auth tables built into the Drizzle package so you don\u0026#39;t need to write those types; they\u0026#39;re just built into Drizzle. So cool!\u003c/li\u003e\n\u003cli\u003eThe OSS team is also super nice and helpful.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSo let\u0026#39;s get started! We\u0026#39;re going to need a few packages\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003enpm i drizzle-orm @neondatabase/serverless dotenv\nnpm i -D drizzle-kit drizzle-seed\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eThe ORM package is package that you\u0026#39;ll actually use in your codebase.\u003c/li\u003e\n\u003cli\u003eThe drizzle-kit package is all the CLI commands you need to run Drizzle. So creating migrations, running migrations, etc.\u003c/li\u003e\n\u003cli\u003eWe could use the normal pg and postgres.js packages, and in many cases you might want to. These use TCP for their connections and support connection pooling that leave connections open which means lower-latency and generally faster connections. However initial connections for these sorts of packages take a while and really aren\u0026#39;t a good fit for things like serverless environments where connections will be spinning up and spinning down frequently.\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;re going to use the Neon serverless driver. This allows us to do SQL over either HTTP or WebSockets (and we\u0026#39;re going to do HTTP.) Honestly if we were going to scale up this project, we\u0026#39;d probably want to do the TCP drivers as it might make more sense, but I usually get started with the serverless driver and switch when I see it being helpful. Both work really well.\u003c/li\u003e\n\u003cli\u003eDoing Neon over HTTP is perfectly suited for Vercel\u0026#39;s serverless architecture, but it does carry some performance overhead. If you\u0026#39;re really performance sensitive or doing transactions is really important to you, we\u0026#39;d need to re-architect this to happen over websockets. But we don\u0026#39;t so this works!\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;re also install drizzle-seed which makes seeding your Drizzle database very easy.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOkay, let\u0026#39;s start making our database work. Normally you\u0026#39;d need to go to Neon.com and create your project and get your DATABASE_URL and put that in your .env file, but we did that as part of setting up auth. So let\u0026#39;s go ahead and start with our config.\u003c/p\u003e\n\u003cp\u003eGo create in the root of the project drizzle.config.ts. Put in there\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;dotenv/config\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { defineConfig } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-kit\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edefineConfig\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003eout\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;./drizzle\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003eschema\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;./src/db/schema.ts\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003edialect\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;postgresql\u0026quot;\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003edbCredentials\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003eurl\u003c/span\u003e: process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDATABASE_URL\u003c/span\u003e!,\n  },\n});\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis is just some basic config for Drizzle, nothing of note.\u003c/p\u003e\n\u003cp\u003eNow go create src/db as a folder. Put in there schema.ts\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { pgTable, serial, text, timestamp, \u003cspan class=\"hljs-built_in\"\u003eboolean\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-orm/pg-core\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { usersSync } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-orm/neon\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e articles = \u003cspan class=\"hljs-title function_\"\u003epgTable\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;articles\u0026quot;\u003c/span\u003e, {\n  \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003eserial\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;id\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eprimaryKey\u003c/span\u003e(),\n  \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etext\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;title\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e(),\n  \u003cspan class=\"hljs-attr\"\u003eslug\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etext\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;slug\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003eunique\u003c/span\u003e(),\n  \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etext\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;content\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e(),\n  \u003cspan class=\"hljs-attr\"\u003eimageUrl\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etext\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;image_url\u0026quot;\u003c/span\u003e),\n  \u003cspan class=\"hljs-attr\"\u003epublished\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003eboolean\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;published\u0026quot;\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003edefault\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e(),\n  \u003cspan class=\"hljs-attr\"\u003eauthorId\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etext\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;author_id\u0026quot;\u003c/span\u003e)\n    .\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e()\n    .\u003cspan class=\"hljs-title function_\"\u003ereferences\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e usersSync.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e),\n  \u003cspan class=\"hljs-attr\"\u003ecreatedAt\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etimestamp\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;created_at\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003emode\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;string\u0026quot;\u003c/span\u003e }).\u003cspan class=\"hljs-title function_\"\u003edefaultNow\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e(),\n  \u003cspan class=\"hljs-attr\"\u003eupdatedAt\u003c/span\u003e: \u003cspan class=\"hljs-title function_\"\u003etimestamp\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;updated_at\u0026quot;\u003c/span\u003e, { \u003cspan class=\"hljs-attr\"\u003emode\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;string\u0026quot;\u003c/span\u003e }).\u003cspan class=\"hljs-title function_\"\u003edefaultNow\u003c/span\u003e().\u003cspan class=\"hljs-title function_\"\u003enotNull\u003c/span\u003e(),\n});\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e schema = { articles };\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e schema;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArticle\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e articles.\u003cspan class=\"hljs-property\"\u003e$inferSelect\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNewArticle\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e articles.\u003cspan class=\"hljs-property\"\u003e$inferInsert\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eWhile this is a lot of new code for you, if you know SQL it should all look \u003cem\u003esuper\u003c/em\u003e familiar to you. We\u0026#39;re basically doing \u003ccode\u003eCREATE TABLE\u003c/code\u003e commands in code. We\u0026#39;re describing what data types we want and what constraints we want (like notNull or unique).\u003c/li\u003e\n\u003cli\u003eusersSync from the neon portion of the drizzle-orm package describes the users table from Neon Auth. It\u0026#39;s a table that already exists, and we already have all the types and such from Drizzle, made by the Neon and Drizzle team. Pretty cool that it already exists!\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ereferences\u003c/code\u003e sets up a foreign key. That means the authorId references the id key in the usersSync table.\u003c/li\u003e\n\u003cli\u003eWhat\u0026#39;s nice is we\u0026#39;re not stuck calling \u0026quot;created_at\u0026quot; using snake case in JavaScript. Drizzle makes it easy for us to define our own alias of what we want to call it in code versus what it\u0026#39;s called in the database. This was particularly helpful in a codebase I was working in where the actual names of the columns were very long and annoying due to being apart of another system but we could call it whatever we wanted in JS code.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$inferSelect\u003c/code\u003e and \u003ccode\u003e$inferInsert\u003c/code\u003e are probably two of the coolest black magic features in code I\u0026#39;ve ever used. It takes the database shape that we set up for the articles tables and turns it into a TypeScript type. We write the code once and we get both the TypeScript types and the database ORM to use. Amazing. If you\u0026#39;re writing raw SQL, you need to author and maintain those types yourself.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThat\u0026#39;s it! Now we have a schema that we can use to create our database connection. Go create an index.ts file in the same directory.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { neon } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@neondatabase/serverless\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { drizzle } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-orm/neon-http\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e * \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e schema \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/db/schema\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;dotenv/config\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e sql = \u003cspan class=\"hljs-title function_\"\u003eneon\u003c/span\u003e(process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eDATABASE_URL\u003c/span\u003e!);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e db = \u003cspan class=\"hljs-title function_\"\u003edrizzle\u003c/span\u003e(sql, { schema });\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e db;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis is just setting up the ORM to be ready to be used by your code. If you were using the pg or postgres packages, you\u0026#39;d set those up here instead. It\u0026#39;s really easy to swap in the future - no other code needs to change.\u003c/p\u003e\n\u003cp\u003eOkay, now let\u0026#39;s create our first migration with generate.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003enpx drizzle-kit generate\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis actually creates the drizzle directory in the root of your project (check this code in) and spits out some meta data and raw SQL files. Feel free to read these (I like Drizzle because these are usually pretty readable) but never, ever, ever modify these by hands. You are setting yourself up for major issues if you do because Drizzle assumes it does all of these and will not respect any handcrafted code you chuck in here.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eNote that this creates the migrations but does not apply them. Your Neon database will still be empty until you run migrate.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eNow let\u0026#39;s run it.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003enpx drizzle-kit migrate\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis applies what we made with generate. And now you can see the empty tables in Neon. Pretty cool, right!?\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eYou can also run \u003ccode\u003enpx drizzle-kit push\u003c/code\u003e to just yolo apply whatever schema you have at the moment. This is nice when you\u0026#39;re making changes and you just want to apply the new schema and aren\u0026#39;t ready to codify what you have as code.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eI wrote a little seed script for you to have some database. \u003cstrong\u003eNote: you must have at least one user signed up via Neon Auth or this does not work\u003c/strong\u003e. Either sign up via your website or add one manually via the Neon console.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/btholt/fullstack-next-wiki/tree/main/04-database/src/db/seed.ts\"\u003eCopy and paste all of this code\u003c/a\u003e into db/seed.ts.\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s make all of these npm scripts.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-comment\"\u003e// the end of your scripts in your package.json\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003e\u0026quot;db:seed\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;tsx src/db/seed.ts\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003e\u0026quot;db:generate\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-kit generate\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003e\u0026quot;db:migrate\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-kit migrate\u0026quot;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWe\u0026#39;ll need tsx for this as well (run TypeScript files as Node, just makes it easy) so run \u003ccode\u003enpm i -D tsx\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eSo feel free to run \u003ccode\u003enpm run db:seed\u003c/code\u003e now and you should have five articles in your database now to play with.\u003c/p\u003e\n\u003cp\u003eAwesome. Let\u0026#39;s go \u003cem\u003euse\u003c/em\u003e these now.\u003c/p\u003e\n","markdown":"We are going to get started writing to our database using Drizzle. Drizzle is a phenomenal ORM, which stands for object-relational mapping. In reality it just means a it's a software package where you define the shape of your data, and it takes care of managing and querying the database for you. Instead of writing raw SQL statements, you write code that then gets translated into SQL for you.\n\nIn the past I did not recommend using an ORM (I think you can find this in my previous Frontend Masters courses!) Why not? I had some pretty bad experiences over the year using ORMs in the earlier days of my career (mostly in PHP and Java.) I'd start using an ORM and it would be amazing: it made it easy to get started, to do basic selects and inserts, and the general 95% use case (and I'll say generally speaking, writing this sort of SQL is not hard.) The problem came when you needed to do more advanced querying that the designers of the ORM didn't anticipate. All the sudden what was helping you work faster was a huge impedance on you doing what you want to do. You're suddenly fighting the framework instead of being helped by it. This happened frequently enough that I decided I'd rather just write SQL, and I did that for most of my career (I also like SQL, but it took a lot of practice for me to say that.)\n\nSo why now? Why do I like Drizzle instead of choosing to just to continue to do raw SQL?\n\n- Its design is very SQL-ish. A lot of other ORMs try to hide SQL from you and in the process make it hard when you need to do SQL-ish things. that's probably my biggest complaint about other ORMs and I _don't_ have that about Drizzle.\n- TypeScript support, and that's the biggest reason _to_ use Drizzle. When you describe something in Drizzle, all the sudden you have amazing TypeScript support for all your database queries. Otherwise you'd be stuck writing all these types yourself and with Drizzle you just don't have to.\n- They even go one step further and they make little packages for each database provider. For Neon, we have all the Neon Auth tables built into the Drizzle package so you don't need to write those types; they're just built into Drizzle. So cool!\n- The OSS team is also super nice and helpful.\n\nSo let's get started! We're going to need a few packages\n\n```bash\nnpm i drizzle-orm @neondatabase/serverless dotenv\nnpm i -D drizzle-kit drizzle-seed\n```\n\n- The ORM package is package that you'll actually use in your codebase.\n- The drizzle-kit package is all the CLI commands you need to run Drizzle. So creating migrations, running migrations, etc.\n- We could use the normal pg and postgres.js packages, and in many cases you might want to. These use TCP for their connections and support connection pooling that leave connections open which means lower-latency and generally faster connections. However initial connections for these sorts of packages take a while and really aren't a good fit for things like serverless environments where connections will be spinning up and spinning down frequently.\n- We're going to use the Neon serverless driver. This allows us to do SQL over either HTTP or WebSockets (and we're going to do HTTP.) Honestly if we were going to scale up this project, we'd probably want to do the TCP drivers as it might make more sense, but I usually get started with the serverless driver and switch when I see it being helpful. Both work really well.\n- Doing Neon over HTTP is perfectly suited for Vercel's serverless architecture, but it does carry some performance overhead. If you're really performance sensitive or doing transactions is really important to you, we'd need to re-architect this to happen over websockets. But we don't so this works!\n- We're also install drizzle-seed which makes seeding your Drizzle database very easy.\n\nOkay, let's start making our database work. Normally you'd need to go to Neon.com and create your project and get your DATABASE_URL and put that in your .env file, but we did that as part of setting up auth. So let's go ahead and start with our config.\n\nGo create in the root of the project drizzle.config.ts. Put in there\n\n```typescript\nimport \"dotenv/config\";\nimport { defineConfig } from \"drizzle-kit\";\n\nexport default defineConfig({\n  out: \"./drizzle\",\n  schema: \"./src/db/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL!,\n  },\n});\n```\n\nThis is just some basic config for Drizzle, nothing of note.\n\nNow go create src/db as a folder. Put in there schema.ts\n\n```typescript\nimport { pgTable, serial, text, timestamp, boolean } from \"drizzle-orm/pg-core\";\nimport { usersSync } from \"drizzle-orm/neon\";\n\nexport const articles = pgTable(\"articles\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  content: text(\"content\").notNull(),\n  imageUrl: text(\"image_url\"),\n  published: boolean(\"published\").default(false).notNull(),\n  authorId: text(\"author_id\")\n    .notNull()\n    .references(() =\u003e usersSync.id),\n  createdAt: timestamp(\"created_at\", { mode: \"string\" }).defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\", { mode: \"string\" }).defaultNow().notNull(),\n});\n\nconst schema = { articles };\nexport default schema;\n\nexport type Article = typeof articles.$inferSelect;\nexport type NewArticle = typeof articles.$inferInsert;\n```\n\n- While this is a lot of new code for you, if you know SQL it should all look _super_ familiar to you. We're basically doing `CREATE TABLE` commands in code. We're describing what data types we want and what constraints we want (like notNull or unique).\n- usersSync from the neon portion of the drizzle-orm package describes the users table from Neon Auth. It's a table that already exists, and we already have all the types and such from Drizzle, made by the Neon and Drizzle team. Pretty cool that it already exists!\n- `references` sets up a foreign key. That means the authorId references the id key in the usersSync table.\n- What's nice is we're not stuck calling \"created_at\" using snake case in JavaScript. Drizzle makes it easy for us to define our own alias of what we want to call it in code versus what it's called in the database. This was particularly helpful in a codebase I was working in where the actual names of the columns were very long and annoying due to being apart of another system but we could call it whatever we wanted in JS code.\n- `$inferSelect` and `$inferInsert` are probably two of the coolest black magic features in code I've ever used. It takes the database shape that we set up for the articles tables and turns it into a TypeScript type. We write the code once and we get both the TypeScript types and the database ORM to use. Amazing. If you're writing raw SQL, you need to author and maintain those types yourself.\n\nThat's it! Now we have a schema that we can use to create our database connection. Go create an index.ts file in the same directory.\n\n```typescript\nimport { neon } from \"@neondatabase/serverless\";\nimport { drizzle } from \"drizzle-orm/neon-http\";\nimport * as schema from \"@/db/schema\";\nimport \"dotenv/config\";\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql, { schema });\n\nexport default db;\n```\n\nThis is just setting up the ORM to be ready to be used by your code. If you were using the pg or postgres packages, you'd set those up here instead. It's really easy to swap in the future - no other code needs to change.\n\nOkay, now let's create our first migration with generate.\n\n```bash\nnpx drizzle-kit generate\n```\n\nThis actually creates the drizzle directory in the root of your project (check this code in) and spits out some meta data and raw SQL files. Feel free to read these (I like Drizzle because these are usually pretty readable) but never, ever, ever modify these by hands. You are setting yourself up for major issues if you do because Drizzle assumes it does all of these and will not respect any handcrafted code you chuck in here.\n\n\u003e Note that this creates the migrations but does not apply them. Your Neon database will still be empty until you run migrate.\n\nNow let's run it.\n\n```bash\nnpx drizzle-kit migrate\n```\n\nThis applies what we made with generate. And now you can see the empty tables in Neon. Pretty cool, right!?\n\n\u003e You can also run `npx drizzle-kit push` to just yolo apply whatever schema you have at the moment. This is nice when you're making changes and you just want to apply the new schema and aren't ready to codify what you have as code.\n\nI wrote a little seed script for you to have some database. **Note: you must have at least one user signed up via Neon Auth or this does not work**. Either sign up via your website or add one manually via the Neon console.\n\n[Copy and paste all of this code][seed] into db/seed.ts.\n\nLet's make all of these npm scripts.\n\n```json\n// the end of your scripts in your package.json\n\"db:seed\": \"tsx src/db/seed.ts\",\n\"db:generate\": \"drizzle-kit generate\",\n\"db:migrate\": \"drizzle-kit migrate\"\n```\n\nWe'll need tsx for this as well (run TypeScript files as Node, just makes it easy) so run `npm i -D tsx`\n\nSo feel free to run `npm run db:seed` now and you should have five articles in your database now to play with.\n\nAwesome. Let's go _use_ these now.\n\n[seed]: https://github.com/btholt/fullstack-next-wiki/tree/main/04-database/src/db/seed.ts\n","slug":"setting-up-drizzle","title":"Setting up Drizzle","section":"Database","icon":"database","filePath":"/home/runner/work/build-a-fullstack-nextjs-app-v4/build-a-fullstack-nextjs-app-v4/lessons/04-database/B-setting-up-drizzle.md","nextSlug":"/lessons/database/query-with-drizzle","prevSlug":"/lessons/database/neon-and-postgres"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"database","slug":"setting-up-drizzle"},"buildId":"XOcKuB9gZ84DgFGtHvLgN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>