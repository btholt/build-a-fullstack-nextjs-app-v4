<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Authorization ‚Äì Build a Fullstack Next.js App, v4</title><meta name="description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="keywords" content="Next.js,fullstack,React,TypeScript,authentication,database,Postgres,Vercel,deployment,SaaS,AI integration,modern web development" data-next-head=""/><meta name="og:description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="og:title" content="Authorization ‚Äì Build a Fullstack Next.js App, v4" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/de2ef606dd4d4a67.css" as="style"/><link rel="stylesheet" href="/_next/static/css/de2ef606dd4d4a67.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b66ed8ba6f029a99.js" defer=""></script><script src="/_next/static/chunks/framework-b1e5f14688f9ffe6.js" defer=""></script><script src="/_next/static/chunks/main-953f8078176d6f7b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-04cfcdd17f247960.js" defer=""></script><script src="/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-e3f3acd10ab352ae.js" defer=""></script><script src="/_next/static/XOcKuB9gZ84DgFGtHvLgN/_buildManifest.js" defer=""></script><script src="/_next/static/XOcKuB9gZ84DgFGtHvLgN/_ssgManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Build a Fullstack Next.js App, v4</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/fullstack-app-next-v4/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>Now that we have both Neon Auth and the database, we can implement authorization (often abbreviated as authZ vs authN which is short for authentication).</p>
<p>Because it confuses a lot of people, let&#39;s quickly disambiguate the two. Authentication is logging in, logging out, and signing up. It&#39;s you handshaking to the service &quot;this is who I am&quot; via social login, username-and-password, etc. Authentication answers the question <strong>who is it</strong>? Authorization is taking your identity and asking the question <strong>what are you allowed to do?</strong> I can be logged in to Facebook but I can&#39;t see everyone&#39;s DMs. Why? Because I am not authorized to do so. However you are authorized to see your own DMs. And possibly the admins / moderators of Facebook can see them too, because they may be authorized to see <em>anyone</em>&#39;s DMs.</p>
<p>We already did authentication when we implemented Stack Auth. But we haven&#39;t done anything with authorization. We just said &quot;if you&#39;re logged in you&#39;re authorized to do anything&quot;. Let&#39;s go make it so you can only edit your own posts.</p>
<blockquote>
<p>You&#39;ll see authZ and authN everywhere. Generally speaking when people write &quot;Auth&quot; they mean either just authN or both authZ and authN.</p>
</blockquote>
<p>Go to the db folder and create a file called authz.ts and put this in there</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { eq } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;drizzle-orm&quot;</span>;
<span class="hljs-keyword">import</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/db/index&quot;</span>;
<span class="hljs-keyword">import</span> { articles } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/db/schema&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> authorizeUserToEditArticle = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">authorizeArticle</span>(<span class="hljs-params">
  <span class="hljs-attr">loggedInUserId</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">articleId</span>: <span class="hljs-built_in">number</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> db
    .<span class="hljs-title function_">select</span>({
      <span class="hljs-attr">authorId</span>: articles.<span class="hljs-property">authorId</span>,
    })
    .<span class="hljs-title function_">from</span>(articles)
    .<span class="hljs-title function_">where</span>(<span class="hljs-title function_">eq</span>(articles.<span class="hljs-property">id</span>, articleId));

  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">return</span> response[<span class="hljs-number">0</span>].<span class="hljs-property">authorId</span> === loggedInUserId;
};
</code></pre><p>This takes in an article ID and a user ID and returns if they are able to edit that article or not. Then we can reuse this helper in several places. Later, if we ant to add an editor role that can edit anything, we could just add it here and have it work everywhere. That&#39;s the idea.</p>
<p>There&#39;s two ways I could have written this. I chose to write the authZ part in TypeScript, <code>response[0].authorId === loggedInUserId</code>. We could have written this as SQL, <code>and(eq(articles.id, articleId), eq(articles.authorId, loggedInUserId))</code> and let the database done the checking instead of us in TypeScript. Inevitably someone will take exception to the fact this was written this way, so let me explain myself.</p>
<ul>
<li>Letting the database do it will be ever-so-slightly more performant, probably, which is why some people were prefer that way. You may need to add an index to accomplish that, but that&#39;s not really a big enough deal for that to be a reason to not do it.</li>
<li>I like doing it in code because I find the code more readable, and the performance hit is so minimal that I choose to value what I find more readable over what could save a millisecond.</li>
<li>Doing it in code would make it easier to refactor later to add other authZ logic here.</li>
</ul>
<p>Okay, we have authZ logic, now go back to your articles.ts in your actions directory and let&#39;s implement it there</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// at top</span>
<span class="hljs-keyword">import</span> { authorizeUserToEditArticle } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/db/authz&quot;</span>;

<span class="hljs-comment">// put after authorized check in delete and update function</span>
<span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">await</span> <span class="hljs-title function_">authorizeUserToEditArticle</span>(user.<span class="hljs-property">id</span>, +id))) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;‚ùå Forbidden&quot;</span>);
}
</code></pre><p>That&#39;s it!</p>
<p>What about error handling? There&#39;s a couple ways of handling errors with server actions and I find this to be the most straightforward: just throw an error and catch it on the client. This isn&#39;t like a normal API with status codes and such - with a server action there&#39;s no public reusable API, just really remote code execution. You could also return status codes in the replies if you want to mimic that aspect of API calls, but that point you may almost just be better off making real APIs. The point of server actions to have them feel more like code than remote API invocations.</p>
<blockquote>
<p>üèÅ This is the <a href="https://github.com/btholt/fullstack-next-wiki/tree/main/04-database">04-database</a> checkpoint. Open that folder in the sample project repo to go to where we are as of right here.</p>
</blockquote>
</div><div class="lesson-links"><a href="/lessons/database/writes-with-drizzle" class="prev">‚Üê Previous</a><a href="/lessons/object-storage/vercel-blob" class="next">Next ‚Üí</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><link id="highlight-theme-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-light.min.css"/><link id="highlight-theme-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-dark.min.css" disabled=""/><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{},"html":"\u003cp\u003eNow that we have both Neon Auth and the database, we can implement authorization (often abbreviated as authZ vs authN which is short for authentication).\u003c/p\u003e\n\u003cp\u003eBecause it confuses a lot of people, let\u0026#39;s quickly disambiguate the two. Authentication is logging in, logging out, and signing up. It\u0026#39;s you handshaking to the service \u0026quot;this is who I am\u0026quot; via social login, username-and-password, etc. Authentication answers the question \u003cstrong\u003ewho is it\u003c/strong\u003e? Authorization is taking your identity and asking the question \u003cstrong\u003ewhat are you allowed to do?\u003c/strong\u003e I can be logged in to Facebook but I can\u0026#39;t see everyone\u0026#39;s DMs. Why? Because I am not authorized to do so. However you are authorized to see your own DMs. And possibly the admins / moderators of Facebook can see them too, because they may be authorized to see \u003cem\u003eanyone\u003c/em\u003e\u0026#39;s DMs.\u003c/p\u003e\n\u003cp\u003eWe already did authentication when we implemented Stack Auth. But we haven\u0026#39;t done anything with authorization. We just said \u0026quot;if you\u0026#39;re logged in you\u0026#39;re authorized to do anything\u0026quot;. Let\u0026#39;s go make it so you can only edit your own posts.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eYou\u0026#39;ll see authZ and authN everywhere. Generally speaking when people write \u0026quot;Auth\u0026quot; they mean either just authN or both authZ and authN.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eGo to the db folder and create a file called authz.ts and put this in there\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { eq } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-orm\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e db \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/db/index\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { articles } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/db/schema\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e authorizeUserToEditArticle = \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eauthorizeArticle\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\n  \u003cspan class=\"hljs-attr\"\u003eloggedInUserId\u003c/span\u003e: \u003cspan class=\"hljs-built_in\"\u003estring\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003earticleId\u003c/span\u003e: \u003cspan class=\"hljs-built_in\"\u003enumber\u003c/span\u003e\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003ePromise\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eboolean\u003c/span\u003e\u0026gt; {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e response = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e db\n    .\u003cspan class=\"hljs-title function_\"\u003eselect\u003c/span\u003e({\n      \u003cspan class=\"hljs-attr\"\u003eauthorId\u003c/span\u003e: articles.\u003cspan class=\"hljs-property\"\u003eauthorId\u003c/span\u003e,\n    })\n    .\u003cspan class=\"hljs-title function_\"\u003efrom\u003c/span\u003e(articles)\n    .\u003cspan class=\"hljs-title function_\"\u003ewhere\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eeq\u003c/span\u003e(articles.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, articleId));\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!response.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e response[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e].\u003cspan class=\"hljs-property\"\u003eauthorId\u003c/span\u003e === loggedInUserId;\n};\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis takes in an article ID and a user ID and returns if they are able to edit that article or not. Then we can reuse this helper in several places. Later, if we ant to add an editor role that can edit anything, we could just add it here and have it work everywhere. That\u0026#39;s the idea.\u003c/p\u003e\n\u003cp\u003eThere\u0026#39;s two ways I could have written this. I chose to write the authZ part in TypeScript, \u003ccode\u003eresponse[0].authorId === loggedInUserId\u003c/code\u003e. We could have written this as SQL, \u003ccode\u003eand(eq(articles.id, articleId), eq(articles.authorId, loggedInUserId))\u003c/code\u003e and let the database done the checking instead of us in TypeScript. Inevitably someone will take exception to the fact this was written this way, so let me explain myself.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLetting the database do it will be ever-so-slightly more performant, probably, which is why some people were prefer that way. You may need to add an index to accomplish that, but that\u0026#39;s not really a big enough deal for that to be a reason to not do it.\u003c/li\u003e\n\u003cli\u003eI like doing it in code because I find the code more readable, and the performance hit is so minimal that I choose to value what I find more readable over what could save a millisecond.\u003c/li\u003e\n\u003cli\u003eDoing it in code would make it easier to refactor later to add other authZ logic here.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOkay, we have authZ logic, now go back to your articles.ts in your actions directory and let\u0026#39;s implement it there\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// at top\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { authorizeUserToEditArticle } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/db/authz\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e// put after authorized check in delete and update function\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!(\u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eauthorizeUserToEditArticle\u003c/span\u003e(user.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, +id))) {\n  \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eError\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;‚ùå Forbidden\u0026quot;\u003c/span\u003e);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThat\u0026#39;s it!\u003c/p\u003e\n\u003cp\u003eWhat about error handling? There\u0026#39;s a couple ways of handling errors with server actions and I find this to be the most straightforward: just throw an error and catch it on the client. This isn\u0026#39;t like a normal API with status codes and such - with a server action there\u0026#39;s no public reusable API, just really remote code execution. You could also return status codes in the replies if you want to mimic that aspect of API calls, but that point you may almost just be better off making real APIs. The point of server actions to have them feel more like code than remote API invocations.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eüèÅ This is the \u003ca href=\"https://github.com/btholt/fullstack-next-wiki/tree/main/04-database\"\u003e04-database\u003c/a\u003e checkpoint. Open that folder in the sample project repo to go to where we are as of right here.\u003c/p\u003e\n\u003c/blockquote\u003e\n","markdown":"Now that we have both Neon Auth and the database, we can implement authorization (often abbreviated as authZ vs authN which is short for authentication).\n\nBecause it confuses a lot of people, let's quickly disambiguate the two. Authentication is logging in, logging out, and signing up. It's you handshaking to the service \"this is who I am\" via social login, username-and-password, etc. Authentication answers the question **who is it**? Authorization is taking your identity and asking the question **what are you allowed to do?** I can be logged in to Facebook but I can't see everyone's DMs. Why? Because I am not authorized to do so. However you are authorized to see your own DMs. And possibly the admins / moderators of Facebook can see them too, because they may be authorized to see _anyone_'s DMs.\n\nWe already did authentication when we implemented Stack Auth. But we haven't done anything with authorization. We just said \"if you're logged in you're authorized to do anything\". Let's go make it so you can only edit your own posts.\n\n\u003e You'll see authZ and authN everywhere. Generally speaking when people write \"Auth\" they mean either just authN or both authZ and authN.\n\nGo to the db folder and create a file called authz.ts and put this in there\n\n```typescript\nimport { eq } from \"drizzle-orm\";\nimport db from \"@/db/index\";\nimport { articles } from \"@/db/schema\";\n\nexport const authorizeUserToEditArticle = async function authorizeArticle(\n  loggedInUserId: string,\n  articleId: number\n): Promise\u003cboolean\u003e {\n  const response = await db\n    .select({\n      authorId: articles.authorId,\n    })\n    .from(articles)\n    .where(eq(articles.id, articleId));\n\n  if (!response.length) {\n    return false;\n  }\n\n  return response[0].authorId === loggedInUserId;\n};\n```\n\nThis takes in an article ID and a user ID and returns if they are able to edit that article or not. Then we can reuse this helper in several places. Later, if we ant to add an editor role that can edit anything, we could just add it here and have it work everywhere. That's the idea.\n\nThere's two ways I could have written this. I chose to write the authZ part in TypeScript, `response[0].authorId === loggedInUserId`. We could have written this as SQL, `and(eq(articles.id, articleId), eq(articles.authorId, loggedInUserId))` and let the database done the checking instead of us in TypeScript. Inevitably someone will take exception to the fact this was written this way, so let me explain myself.\n\n- Letting the database do it will be ever-so-slightly more performant, probably, which is why some people were prefer that way. You may need to add an index to accomplish that, but that's not really a big enough deal for that to be a reason to not do it.\n- I like doing it in code because I find the code more readable, and the performance hit is so minimal that I choose to value what I find more readable over what could save a millisecond.\n- Doing it in code would make it easier to refactor later to add other authZ logic here.\n\nOkay, we have authZ logic, now go back to your articles.ts in your actions directory and let's implement it there\n\n```typescript\n// at top\nimport { authorizeUserToEditArticle } from \"@/db/authz\";\n\n// put after authorized check in delete and update function\nif (!(await authorizeUserToEditArticle(user.id, +id))) {\n  throw new Error(\"‚ùå Forbidden\");\n}\n```\n\nThat's it!\n\nWhat about error handling? There's a couple ways of handling errors with server actions and I find this to be the most straightforward: just throw an error and catch it on the client. This isn't like a normal API with status codes and such - with a server action there's no public reusable API, just really remote code execution. You could also return status codes in the replies if you want to mimic that aspect of API calls, but that point you may almost just be better off making real APIs. The point of server actions to have them feel more like code than remote API invocations.\n\n\u003e üèÅ This is the [04-database][checkpoint] checkpoint. Open that folder in the sample project repo to go to where we are as of right here.\n\n[checkpoint]: https://github.com/btholt/fullstack-next-wiki/tree/main/04-database\n","slug":"authorization","title":"Authorization","section":"Database","icon":"database","filePath":"/home/runner/work/build-a-fullstack-nextjs-app-v4/build-a-fullstack-nextjs-app-v4/lessons/04-database/E-authorization.md","nextSlug":"/lessons/object-storage/vercel-blob","prevSlug":"/lessons/database/writes-with-drizzle"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"database","slug":"authorization"},"buildId":"XOcKuB9gZ84DgFGtHvLgN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>