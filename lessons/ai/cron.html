<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Cron ‚Äì Build a Fullstack Next.js App, v4</title><meta name="description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="keywords" content="Next.js,fullstack,React,TypeScript,authentication,database,Postgres,Vercel,deployment,SaaS,AI integration,modern web development" data-next-head=""/><meta name="og:description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="og:title" content="Cron ‚Äì Build a Fullstack Next.js App, v4" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/de2ef606dd4d4a67.css" as="style"/><link rel="stylesheet" href="/_next/static/css/de2ef606dd4d4a67.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b66ed8ba6f029a99.js" defer=""></script><script src="/_next/static/chunks/framework-b1e5f14688f9ffe6.js" defer=""></script><script src="/_next/static/chunks/main-03ed03852b4b217f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-04cfcdd17f247960.js" defer=""></script><script src="/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-e3f3acd10ab352ae.js" defer=""></script><script src="/_next/static/3u4FnQFUETt3ux6gefDHe/_buildManifest.js" defer=""></script><script src="/_next/static/3u4FnQFUETt3ux6gefDHe/_ssgManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Build a Fullstack Next.js App, v4</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/fullstack-app-next-v4/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>So, now we have a problem - we have some records that have AI summary records, and some that don&#39;t. Maybe we make those summary updates low priority, or maybe they fail on some normal interval. What can we do about that? We could make it check on reads but that slows down a critical path. What we could do better is schedule a job to run on some reoccurring basis, essentially a <a href="https://btholt.github.io/complete-intro-to-linux-and-the-cli/cron">cron job</a>.</p>
<p>Vercel has a very easy way to do cron jobs for Next.js apps. You just define an API function and Vercel will call the API function for you. Vercel will put in a special variable so you can make sure it&#39;s only Vercel that will call the function too (we don&#39;t want random people invoking our jobs.)</p>
<p>Let&#39;s do it! Let&#39;s make a job that runs weekly to make sure that all items in the database have summaries.</p>
<blockquote>
<p>Why weekly? Every time this runs it&#39;ll wake your Vercel and Neon instances, costing you money or free tier credit. I chose weekly because adding a few minutes week isn&#39;t too bad. If you ran this every minute you&#39;d eat through both Vercel and Neon&#39;s free tiers.</p>
</blockquote>
<p>In src/app, create a new folder, <code>api</code>. In the api directory, make a new directory, <code>summary</code>. In there, create a new file, <code>route.ts</code>.</p>
<p>In there put:</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/server&quot;</span>;
<span class="hljs-keyword">import</span> { eq, isNull } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;drizzle-orm&quot;</span>;
<span class="hljs-keyword">import</span> summarizeArticle <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/ai/summarize&quot;</span>;
<span class="hljs-keyword">import</span> db <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/db&quot;</span>;
<span class="hljs-keyword">import</span> { articles } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/db/schema&quot;</span>;
<span class="hljs-keyword">import</span> redis <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/cache&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params"><span class="hljs-attr">req</span>: <span class="hljs-title class_">NextRequest</span></span>) {
  <span class="hljs-keyword">if</span> (
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">&quot;development&quot;</span> &amp;&amp;
    req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;authorization&quot;</span>) !== <span class="hljs-string">`Bearer <span class="hljs-subst">${process.env.CRON_SECRET}</span>`</span>
  ) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;Unauthorized&quot;</span> }, { <span class="hljs-attr">status</span>: <span class="hljs-number">401</span> });
  }

  <span class="hljs-comment">// Find articles that don&#x27;t yet have a summary</span>
  <span class="hljs-keyword">const</span> rows = <span class="hljs-keyword">await</span> db
    .<span class="hljs-title function_">select</span>({
      <span class="hljs-attr">id</span>: articles.<span class="hljs-property">id</span>,
      <span class="hljs-attr">title</span>: articles.<span class="hljs-property">title</span>,
      <span class="hljs-attr">content</span>: articles.<span class="hljs-property">content</span>,
    })
    .<span class="hljs-title function_">from</span>(articles)
    .<span class="hljs-title function_">where</span>(<span class="hljs-title function_">isNull</span>(articles.<span class="hljs-property">summary</span>));

  <span class="hljs-keyword">if</span> (!rows || rows.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">updated</span>: <span class="hljs-number">0</span> });
  }

  <span class="hljs-keyword">let</span> updated = <span class="hljs-number">0</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;ü§ñ Starting AI summary job&quot;</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> row <span class="hljs-keyword">of</span> rows) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> summary = <span class="hljs-keyword">await</span> <span class="hljs-title function_">summarizeArticle</span>(row.<span class="hljs-property">title</span> ?? <span class="hljs-string">&quot;&quot;</span>, row.<span class="hljs-property">content</span>);

      <span class="hljs-keyword">if</span> (summary &amp;&amp; summary.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">await</span> db
          .<span class="hljs-title function_">update</span>(articles)
          .<span class="hljs-title function_">set</span>({ summary })
          .<span class="hljs-title function_">where</span>(<span class="hljs-title function_">eq</span>(articles.<span class="hljs-property">id</span>, row.<span class="hljs-property">id</span>));
        updated++;
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-comment">// log and continue with next article</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;Failed to summarize article id=&quot;</span>, row.<span class="hljs-property">id</span>, err);
      <span class="hljs-keyword">continue</span>;
    }
  }

  <span class="hljs-keyword">if</span> (updated &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Clear articles cache used by getArticles</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">del</span>(<span class="hljs-string">&quot;articles:all&quot;</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&quot;‚ö†Ô∏è Failed to clear articles cache&quot;</span>, e);
    }
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`ü§ñ Concluding AI summary job, updated <span class="hljs-subst">${updated}</span> rows`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, updated });
}
</code></pre><ul>
<li>It now works in dev so we can just hit <code>localhost:3000/api/summary</code> in a browser and it&#39;ll run</li>
<li>In prod it&#39;ll check the CRON header and if it doesn&#39;t match it won&#39;t run.</li>
<li>Beyond that, we&#39;re just reading from the DB and updating rows that don&#39;t have summaries</li>
<li>We also clear cache if any of the articles get updated</li>
</ul>
<p>Make a new file called <code>vercel.json</code> and we&#39;ll have it run once a week.</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;crons&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/api/summary&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;schedule&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0 0 * * 0&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre><p>This will run every Sunday at midnight UTC. Feel free to make it whenever you want. If you need help <a href="https://crontab.guru/#0_0_*_*_0">cron.guru</a> is very helpful.</p>
<p>And there you go! Now you can have AI summaries running once a week, and in general you now how to do jobs with Vercel and Next.js. This is nice but it applies only to Vercel. Generally speaking I&#39;ve usually done these sorts of jobs with serverless functions like Azure Functions or AWS Lambdas as those are easy to schedule.</p>
<p>You also learned how to make API endpoints with Next.js. These days I think unless you&#39;re making endpoints available to outside users or mobile apps, it&#39;s a bit of an anti-pattern to make API endpoints as you should just be using React Server Components do all the connecting between clients and servers.</p>
<p>Lastly we learned how to do migrations with Drizzle. While this is a pretty simple example of it, this is how you do it - just modify your schema files and let Drizzle handle the rest!</p>
<blockquote>
<p>üèÅ This is the <a href="https://github.com/btholt/fullstack-next-wiki/tree/main/08-ai">08-ai</a> checkpoint. Open that folder in the sample project repo to go to where we are as of right here.</p>
</blockquote>
</div><div class="lesson-links"><a href="/lessons/ai/ai-inference" class="prev">‚Üê Previous</a><a href="/lessons/devops/deploy-to-vercel" class="next">Next ‚Üí</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><link id="highlight-theme-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-light.min.css"/><link id="highlight-theme-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-dark.min.css" disabled=""/><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{},"html":"\u003cp\u003eSo, now we have a problem - we have some records that have AI summary records, and some that don\u0026#39;t. Maybe we make those summary updates low priority, or maybe they fail on some normal interval. What can we do about that? We could make it check on reads but that slows down a critical path. What we could do better is schedule a job to run on some reoccurring basis, essentially a \u003ca href=\"https://btholt.github.io/complete-intro-to-linux-and-the-cli/cron\"\u003ecron job\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eVercel has a very easy way to do cron jobs for Next.js apps. You just define an API function and Vercel will call the API function for you. Vercel will put in a special variable so you can make sure it\u0026#39;s only Vercel that will call the function too (we don\u0026#39;t want random people invoking our jobs.)\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s do it! Let\u0026#39;s make a job that runs weekly to make sure that all items in the database have summaries.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWhy weekly? Every time this runs it\u0026#39;ll wake your Vercel and Neon instances, costing you money or free tier credit. I chose weekly because adding a few minutes week isn\u0026#39;t too bad. If you ran this every minute you\u0026#39;d eat through both Vercel and Neon\u0026#39;s free tiers.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eIn src/app, create a new folder, \u003ccode\u003eapi\u003c/code\u003e. In the api directory, make a new directory, \u003ccode\u003esummary\u003c/code\u003e. In there, create a new file, \u003ccode\u003eroute.ts\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIn there put:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eNextRequest\u003c/span\u003e, \u003cspan class=\"hljs-title class_\"\u003eNextResponse\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;next/server\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { eq, isNull } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;drizzle-orm\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e summarizeArticle \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/ai/summarize\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e db \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/db\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { articles } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/db/schema\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e redis \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/cache\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eGET\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003cspan class=\"hljs-attr\"\u003ereq\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eNextRequest\u003c/span\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\n    process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNODE_ENV\u003c/span\u003e !== \u003cspan class=\"hljs-string\"\u003e\u0026quot;development\u0026quot;\u003c/span\u003e \u0026amp;\u0026amp;\n    req.\u003cspan class=\"hljs-property\"\u003eheaders\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;authorization\u0026quot;\u003c/span\u003e) !== \u003cspan class=\"hljs-string\"\u003e`Bearer \u003cspan class=\"hljs-subst\"\u003e${process.env.CRON_SECRET}\u003c/span\u003e`\u003c/span\u003e\n  ) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNextResponse\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eerror\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;Unauthorized\u0026quot;\u003c/span\u003e }, { \u003cspan class=\"hljs-attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e401\u003c/span\u003e });\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// Find articles that don\u0026#x27;t yet have a summary\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e rows = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e db\n    .\u003cspan class=\"hljs-title function_\"\u003eselect\u003c/span\u003e({\n      \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e: articles.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: articles.\u003cspan class=\"hljs-property\"\u003etitle\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003econtent\u003c/span\u003e: articles.\u003cspan class=\"hljs-property\"\u003econtent\u003c/span\u003e,\n    })\n    .\u003cspan class=\"hljs-title function_\"\u003efrom\u003c/span\u003e(articles)\n    .\u003cspan class=\"hljs-title function_\"\u003ewhere\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eisNull\u003c/span\u003e(articles.\u003cspan class=\"hljs-property\"\u003esummary\u003c/span\u003e));\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!rows || rows.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e === \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNextResponse\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eupdated\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e });\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e updated = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;ü§ñ Starting AI summary job\u0026quot;\u003c/span\u003e);\n\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e row \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e rows) {\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e summary = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003esummarizeArticle\u003c/span\u003e(row.\u003cspan class=\"hljs-property\"\u003etitle\u003c/span\u003e ?? \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026quot;\u003c/span\u003e, row.\u003cspan class=\"hljs-property\"\u003econtent\u003c/span\u003e);\n\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (summary \u0026amp;\u0026amp; summary.\u003cspan class=\"hljs-title function_\"\u003etrim\u003c/span\u003e().\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e \u0026gt; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e db\n          .\u003cspan class=\"hljs-title function_\"\u003eupdate\u003c/span\u003e(articles)\n          .\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e({ summary })\n          .\u003cspan class=\"hljs-title function_\"\u003ewhere\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eeq\u003c/span\u003e(articles.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, row.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e));\n        updated++;\n      }\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (err) {\n      \u003cspan class=\"hljs-comment\"\u003e// log and continue with next article\u003c/span\u003e\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;Failed to summarize article id=\u0026quot;\u003c/span\u003e, row.\u003cspan class=\"hljs-property\"\u003eid\u003c/span\u003e, err);\n      \u003cspan class=\"hljs-keyword\"\u003econtinue\u003c/span\u003e;\n    }\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (updated \u0026gt; \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n    \u003cspan class=\"hljs-comment\"\u003e// Clear articles cache used by getArticles\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n      \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e redis.\u003cspan class=\"hljs-title function_\"\u003edel\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;articles:all\u0026quot;\u003c/span\u003e);\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (e) {\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ewarn\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;‚ö†Ô∏è Failed to clear articles cache\u0026quot;\u003c/span\u003e, e);\n    }\n  }\n\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`ü§ñ Concluding AI summary job, updated \u003cspan class=\"hljs-subst\"\u003e${updated}\u003c/span\u003e rows`\u003c/span\u003e);\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNextResponse\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eok\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e, updated });\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eIt now works in dev so we can just hit \u003ccode\u003elocalhost:3000/api/summary\u003c/code\u003e in a browser and it\u0026#39;ll run\u003c/li\u003e\n\u003cli\u003eIn prod it\u0026#39;ll check the CRON header and if it doesn\u0026#39;t match it won\u0026#39;t run.\u003c/li\u003e\n\u003cli\u003eBeyond that, we\u0026#39;re just reading from the DB and updating rows that don\u0026#39;t have summaries\u003c/li\u003e\n\u003cli\u003eWe also clear cache if any of the articles get updated\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMake a new file called \u003ccode\u003evercel.json\u003c/code\u003e and we\u0026#39;ll have it run once a week.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\u0026quot;crons\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;path\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;/api/summary\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003e\u0026quot;schedule\u0026quot;\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;0 0 * * 0\u0026quot;\u003c/span\u003e\n    \u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"hljs-punctuation\"\u003e]\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis will run every Sunday at midnight UTC. Feel free to make it whenever you want. If you need help \u003ca href=\"https://crontab.guru/#0_0_*_*_0\"\u003ecron.guru\u003c/a\u003e is very helpful.\u003c/p\u003e\n\u003cp\u003eAnd there you go! Now you can have AI summaries running once a week, and in general you now how to do jobs with Vercel and Next.js. This is nice but it applies only to Vercel. Generally speaking I\u0026#39;ve usually done these sorts of jobs with serverless functions like Azure Functions or AWS Lambdas as those are easy to schedule.\u003c/p\u003e\n\u003cp\u003eYou also learned how to make API endpoints with Next.js. These days I think unless you\u0026#39;re making endpoints available to outside users or mobile apps, it\u0026#39;s a bit of an anti-pattern to make API endpoints as you should just be using React Server Components do all the connecting between clients and servers.\u003c/p\u003e\n\u003cp\u003eLastly we learned how to do migrations with Drizzle. While this is a pretty simple example of it, this is how you do it - just modify your schema files and let Drizzle handle the rest!\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eüèÅ This is the \u003ca href=\"https://github.com/btholt/fullstack-next-wiki/tree/main/08-ai\"\u003e08-ai\u003c/a\u003e checkpoint. Open that folder in the sample project repo to go to where we are as of right here.\u003c/p\u003e\n\u003c/blockquote\u003e\n","markdown":"So, now we have a problem - we have some records that have AI summary records, and some that don't. Maybe we make those summary updates low priority, or maybe they fail on some normal interval. What can we do about that? We could make it check on reads but that slows down a critical path. What we could do better is schedule a job to run on some reoccurring basis, essentially a [cron job][cron].\n\nVercel has a very easy way to do cron jobs for Next.js apps. You just define an API function and Vercel will call the API function for you. Vercel will put in a special variable so you can make sure it's only Vercel that will call the function too (we don't want random people invoking our jobs.)\n\nLet's do it! Let's make a job that runs weekly to make sure that all items in the database have summaries.\n\n\u003e Why weekly? Every time this runs it'll wake your Vercel and Neon instances, costing you money or free tier credit. I chose weekly because adding a few minutes week isn't too bad. If you ran this every minute you'd eat through both Vercel and Neon's free tiers.\n\nIn src/app, create a new folder, `api`. In the api directory, make a new directory, `summary`. In there, create a new file, `route.ts`.\n\nIn there put:\n\n```typescript\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { eq, isNull } from \"drizzle-orm\";\nimport summarizeArticle from \"@/ai/summarize\";\nimport db from \"@/db\";\nimport { articles } from \"@/db/schema\";\nimport redis from \"@/cache\";\n\nexport async function GET(req: NextRequest) {\n  if (\n    process.env.NODE_ENV !== \"development\" \u0026\u0026\n    req.headers.get(\"authorization\") !== `Bearer ${process.env.CRON_SECRET}`\n  ) {\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n  }\n\n  // Find articles that don't yet have a summary\n  const rows = await db\n    .select({\n      id: articles.id,\n      title: articles.title,\n      content: articles.content,\n    })\n    .from(articles)\n    .where(isNull(articles.summary));\n\n  if (!rows || rows.length === 0) {\n    return NextResponse.json({ ok: true, updated: 0 });\n  }\n\n  let updated = 0;\n  console.log(\"ü§ñ Starting AI summary job\");\n\n  for (const row of rows) {\n    try {\n      const summary = await summarizeArticle(row.title ?? \"\", row.content);\n\n      if (summary \u0026\u0026 summary.trim().length \u003e 0) {\n        await db\n          .update(articles)\n          .set({ summary })\n          .where(eq(articles.id, row.id));\n        updated++;\n      }\n    } catch (err) {\n      // log and continue with next article\n      console.error(\"Failed to summarize article id=\", row.id, err);\n      continue;\n    }\n  }\n\n  if (updated \u003e 0) {\n    // Clear articles cache used by getArticles\n    try {\n      await redis.del(\"articles:all\");\n    } catch (e) {\n      console.warn(\"‚ö†Ô∏è Failed to clear articles cache\", e);\n    }\n  }\n\n  console.log(`ü§ñ Concluding AI summary job, updated ${updated} rows`);\n\n  return NextResponse.json({ ok: true, updated });\n}\n```\n\n- It now works in dev so we can just hit `localhost:3000/api/summary` in a browser and it'll run\n- In prod it'll check the CRON header and if it doesn't match it won't run.\n- Beyond that, we're just reading from the DB and updating rows that don't have summaries\n- We also clear cache if any of the articles get updated\n\nMake a new file called `vercel.json` and we'll have it run once a week.\n\n```json\n{\n  \"crons\": [\n    {\n      \"path\": \"/api/summary\",\n      \"schedule\": \"0 0 * * 0\"\n    }\n  ]\n}\n```\n\nThis will run every Sunday at midnight UTC. Feel free to make it whenever you want. If you need help [cron.guru][guru] is very helpful.\n\nAnd there you go! Now you can have AI summaries running once a week, and in general you now how to do jobs with Vercel and Next.js. This is nice but it applies only to Vercel. Generally speaking I've usually done these sorts of jobs with serverless functions like Azure Functions or AWS Lambdas as those are easy to schedule.\n\nYou also learned how to make API endpoints with Next.js. These days I think unless you're making endpoints available to outside users or mobile apps, it's a bit of an anti-pattern to make API endpoints as you should just be using React Server Components do all the connecting between clients and servers.\n\nLastly we learned how to do migrations with Drizzle. While this is a pretty simple example of it, this is how you do it - just modify your schema files and let Drizzle handle the rest!\n\n\u003e üèÅ This is the [08-ai][checkpoint] checkpoint. Open that folder in the sample project repo to go to where we are as of right here.\n\n[checkpoint]: https://github.com/btholt/fullstack-next-wiki/tree/main/08-ai\n[cron]: https://btholt.github.io/complete-intro-to-linux-and-the-cli/cron\n[guru]: https://crontab.guru/#0_0_*_*_0\n","slug":"cron","title":"Cron","section":"AI","icon":"robot","filePath":"/home/runner/work/build-a-fullstack-nextjs-app-v4/build-a-fullstack-nextjs-app-v4/lessons/08-ai/C-cron.md","nextSlug":"/lessons/devops/deploy-to-vercel","prevSlug":"/lessons/ai/ai-inference"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"ai","slug":"cron"},"buildId":"3u4FnQFUETt3ux6gefDHe","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>