<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">Caching ‚Äì Build a Fullstack Next.js App, v4</title><meta name="description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="keywords" content="Next.js,fullstack,React,TypeScript,authentication,database,Postgres,Vercel,deployment,SaaS,AI integration,modern web development" data-next-head=""/><meta name="og:description" content="Build a production-ready team wiki from scratch using Next.js, TypeScript, and modern SaaS tools. Master authentication, database integration, AI features, and deployment patterns." data-next-head=""/><meta name="og:title" content="Caching ‚Äì Build a Fullstack Next.js App, v4" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/de2ef606dd4d4a67.css" as="style"/><link rel="stylesheet" href="/_next/static/css/de2ef606dd4d4a67.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b66ed8ba6f029a99.js" defer=""></script><script src="/_next/static/chunks/framework-b1e5f14688f9ffe6.js" defer=""></script><script src="/_next/static/chunks/main-953f8078176d6f7b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-04cfcdd17f247960.js" defer=""></script><script src="/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-e3f3acd10ab352ae.js" defer=""></script><script src="/_next/static/XOcKuB9gZ84DgFGtHvLgN/_buildManifest.js" defer=""></script><script src="/_next/static/XOcKuB9gZ84DgFGtHvLgN/_ssgManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Build a Fullstack Next.js App, v4</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/workshops/fullstack-app-next-v4/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>We are going to pretend for a second that our initial page load is reeeeeally slow or expensive (it&#39;s neither at the moment) because it&#39;s querying the database with a heavy query. If that was true, we&#39;d want to cache our database response for that. Let&#39;s go do that.</p>
<blockquote>
<p>Premature optimization kills startups. Generally speaking, don&#39;t do cache something until it&#39;s proven to be a problem. Whenever you try to guess what the scaling problems are going to be, you&#39;re usually wrong, and now you have two problems: an unnecessary hack and an actual scaling problem.</p>
</blockquote>
<p>Let&#39;s first make a client that we can use anywhere. Make a <code>cache</code> directory in app and make an index.ts file and put this in there.</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Redis</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@upstash/redis&quot;</span>;
<span class="hljs-keyword">const</span> redis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Redis</span>({
  <span class="hljs-attr">url</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">UPSTASH_REDIS_REST_URL</span>,
  <span class="hljs-attr">token</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">UPSTASH_REDIS_REST_TOKEN</span>,
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> redis;
</code></pre><p>From there in lib/data/articles.ts, add this</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// at top</span>
<span class="hljs-keyword">import</span> redis <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/cache&quot;</span>;

<span class="hljs-comment">// top of getArticles</span>
<span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;articles:all&quot;</span>);
<span class="hljs-keyword">if</span> (cached) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;üéØ Get Articles Cache Hit!&quot;</span>);
  <span class="hljs-keyword">return</span> cached;
}

<span class="hljs-comment">// above return statement</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;üôÖ‚Äç‚ôÇÔ∏è Get Articles Cache Miss!&quot;</span>);
redis.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;articles:all&quot;</span>, response, {
  <span class="hljs-attr">ex</span>: <span class="hljs-number">60</span>, <span class="hljs-comment">// one minute</span>
});
</code></pre><p>Now we cache the results of the getArticles call for one minute, meaning that we should really only see a little load on the database even under heavy traffic - most of those reads can just go straight to Redis and skip your database all together! Pretty cool!</p>
<blockquote>
<p>Could this be better? Definitely. Instead of just relying on the cache to expire and then reset it in code, we could set the cache to expire in 20 minutes, and then have the cache be refreshed every minute via a job. That way we guarantee that the database is going to be being called every minute with fresh data and no &quot;thundering herd&quot; problems. Thundering herd is what they call it when your cache expires and a ton of traffic spikes on your database all at once causing instability. But this will work for now and it&#39;s nice-and-simple.</p>
</blockquote>
<p>What if someone creates a new article? We want that to show instantly. So let&#39;s go clear the cache on article creation.</p>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// at top</span>
<span class="hljs-keyword">import</span> redis <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/cache&quot;</span>;

<span class="hljs-comment">// bottom of createArticle, above return statement</span>
redis.<span class="hljs-title function_">del</span>(<span class="hljs-string">&quot;articles:all&quot;</span>);
</code></pre><p>That&#39;s it! We clear the cache on new article creation so it&#39;s always immediately available, but otherwise we assert that the data being a minute old is fresh enough.</p>
</div><div class="lesson-links"><a href="/lessons/key-value-store/upstash" class="prev">‚Üê Previous</a><a href="/lessons/key-value-store/counting" class="next">Next ‚Üí</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="100%" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="100%"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul><div class="theme-icons"><link id="highlight-theme-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-light.min.css"/><link id="highlight-theme-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/a11y-dark.min.css" disabled=""/><button aria-label="Activate dark mode" title="Activate dark mode" class="theme-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="36px" height="100%" viewBox="0 -960 960 960" fill="var(--text-footer)" role="img"><title>Dark Mode Icon</title><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Z"></path></svg></button></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{},"html":"\u003cp\u003eWe are going to pretend for a second that our initial page load is reeeeeally slow or expensive (it\u0026#39;s neither at the moment) because it\u0026#39;s querying the database with a heavy query. If that was true, we\u0026#39;d want to cache our database response for that. Let\u0026#39;s go do that.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePremature optimization kills startups. Generally speaking, don\u0026#39;t do cache something until it\u0026#39;s proven to be a problem. Whenever you try to guess what the scaling problems are going to be, you\u0026#39;re usually wrong, and now you have two problems: an unnecessary hack and an actual scaling problem.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eLet\u0026#39;s first make a client that we can use anywhere. Make a \u003ccode\u003ecache\u003c/code\u003e directory in app and make an index.ts file and put this in there.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e { \u003cspan class=\"hljs-title class_\"\u003eRedis\u003c/span\u003e } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@upstash/redis\u0026quot;\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e redis = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRedis\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003eurl\u003c/span\u003e: process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eUPSTASH_REDIS_REST_URL\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003etoken\u003c/span\u003e: process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eUPSTASH_REDIS_REST_TOKEN\u003c/span\u003e,\n});\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e redis;\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eFrom there in lib/data/articles.ts, add this\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// at top\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e redis \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/cache\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e// top of getArticles\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e cached = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e redis.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;articles:all\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (cached) {\n  \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;üéØ Get Articles Cache Hit!\u0026quot;\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e cached;\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// above return statement\u003c/span\u003e\n\u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;üôÖ‚Äç‚ôÇÔ∏è Get Articles Cache Miss!\u0026quot;\u003c/span\u003e);\nredis.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;articles:all\u0026quot;\u003c/span\u003e, response, {\n  \u003cspan class=\"hljs-attr\"\u003eex\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e60\u003c/span\u003e, \u003cspan class=\"hljs-comment\"\u003e// one minute\u003c/span\u003e\n});\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow we cache the results of the getArticles call for one minute, meaning that we should really only see a little load on the database even under heavy traffic - most of those reads can just go straight to Redis and skip your database all together! Pretty cool!\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eCould this be better? Definitely. Instead of just relying on the cache to expire and then reset it in code, we could set the cache to expire in 20 minutes, and then have the cache be refreshed every minute via a job. That way we guarantee that the database is going to be being called every minute with fresh data and no \u0026quot;thundering herd\u0026quot; problems. Thundering herd is what they call it when your cache expires and a ton of traffic spikes on your database all at once causing instability. But this will work for now and it\u0026#39;s nice-and-simple.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWhat if someone creates a new article? We want that to show instantly. So let\u0026#39;s go clear the cache on article creation.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-typescript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// at top\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e redis \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;@/cache\u0026quot;\u003c/span\u003e;\n\n\u003cspan class=\"hljs-comment\"\u003e// bottom of createArticle, above return statement\u003c/span\u003e\nredis.\u003cspan class=\"hljs-title function_\"\u003edel\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;articles:all\u0026quot;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThat\u0026#39;s it! We clear the cache on new article creation so it\u0026#39;s always immediately available, but otherwise we assert that the data being a minute old is fresh enough.\u003c/p\u003e\n","markdown":"We are going to pretend for a second that our initial page load is reeeeeally slow or expensive (it's neither at the moment) because it's querying the database with a heavy query. If that was true, we'd want to cache our database response for that. Let's go do that.\n\n\u003e Premature optimization kills startups. Generally speaking, don't do cache something until it's proven to be a problem. Whenever you try to guess what the scaling problems are going to be, you're usually wrong, and now you have two problems: an unnecessary hack and an actual scaling problem.\n\nLet's first make a client that we can use anywhere. Make a `cache` directory in app and make an index.ts file and put this in there.\n\n```typescript\nimport { Redis } from \"@upstash/redis\";\nconst redis = new Redis({\n  url: process.env.UPSTASH_REDIS_REST_URL,\n  token: process.env.UPSTASH_REDIS_REST_TOKEN,\n});\n\nexport default redis;\n```\n\nFrom there in lib/data/articles.ts, add this\n\n```typescript\n// at top\nimport redis from \"@/cache\";\n\n// top of getArticles\nconst cached = await redis.get(\"articles:all\");\nif (cached) {\n  console.log(\"üéØ Get Articles Cache Hit!\");\n  return cached;\n}\n\n// above return statement\nconsole.log(\"üôÖ‚Äç‚ôÇÔ∏è Get Articles Cache Miss!\");\nredis.set(\"articles:all\", response, {\n  ex: 60, // one minute\n});\n```\n\nNow we cache the results of the getArticles call for one minute, meaning that we should really only see a little load on the database even under heavy traffic - most of those reads can just go straight to Redis and skip your database all together! Pretty cool!\n\n\u003e Could this be better? Definitely. Instead of just relying on the cache to expire and then reset it in code, we could set the cache to expire in 20 minutes, and then have the cache be refreshed every minute via a job. That way we guarantee that the database is going to be being called every minute with fresh data and no \"thundering herd\" problems. Thundering herd is what they call it when your cache expires and a ton of traffic spikes on your database all at once causing instability. But this will work for now and it's nice-and-simple.\n\nWhat if someone creates a new article? We want that to show instantly. So let's go clear the cache on article creation.\n\n```typescript\n// at top\nimport redis from \"@/cache\";\n\n// bottom of createArticle, above return statement\nredis.del(\"articles:all\");\n```\n\nThat's it! We clear the cache on new article creation so it's always immediately available, but otherwise we assert that the data being a minute old is fresh enough.\n","slug":"caching","title":"Caching","section":"Key Value Store","icon":"key","filePath":"/home/runner/work/build-a-fullstack-nextjs-app-v4/build-a-fullstack-nextjs-app-v4/lessons/06-key-value-store/B-caching.md","nextSlug":"/lessons/key-value-store/counting","prevSlug":"/lessons/key-value-store/upstash"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"key-value-store","slug":"caching"},"buildId":"XOcKuB9gZ84DgFGtHvLgN","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>