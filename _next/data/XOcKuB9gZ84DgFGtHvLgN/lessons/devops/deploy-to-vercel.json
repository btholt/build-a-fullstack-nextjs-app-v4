{"pageProps":{"post":{"attributes":{},"html":"<p>We are going to now do all the fun DevOps parts at the end: we are going to deploy, we are going to do CI/CD, and we are going to do observability and analytics.</p>\n<p>There are so many ways to skin this cat so we are going to keep it pretty focused - Vercel offers nearly all of these services built-in and it works really well with Neon and Upstash, so we&#39;re just going to lean on that. If I was just getting started, this is what I&#39;d do - only reason I&#39;d something like a different observability platform or analytics is if I outgrew the perfectly adequate offering on Vercel.</p>\n<p>Go to GitHub, create a new repo, and push your project into that repo. We&#39;re going to use this to deploy. Once you&#39;ve pushed your code to GitHub, go to Vercel.com and create a new project and connect your GitHub so we can add your repo to this project.</p>\n<p>I took the liberty here of fixing some stuff up for deployment, namely adding a bunch of tests. This isn&#39;t a testing Next.js course and if you want to see my opinions on testing Next.js <a href=\"https://holt.fyi/intermediate-react\">check out my Intermediate React course</a> - I go into plenty depth there. So instead I just want you to see what to do with the tests once you have them. I&#39;ve added some test specific code that you can look at if you want (for example it doesn&#39;t run the AI summaries in test because it&#39;d waste a lot of tokens)</p>\n<blockquote>\n<p>üèÅ This is the <a href=\"https://github.com/btholt/fullstack-next-wiki/tree/main/09-with-tests\">09-with-tests</a> checkpoint. Open that folder in the sample project repo to go to where we are as of right here. This is the final version of the project and what we&#39;ll use to deploy.</p>\n</blockquote>\n<p>Another note - these days I mostly vibe code my tests - it&#39;s such a perfect use case for it.</p>\n<p>In this repo, it&#39;ll now expect <em>two</em> sets of variables, if you want to. For the purposes of this course, feel free to just re-use your prod infra for test, but you&#39;ll see how to set up preview environments <em>and</em> prod environments.</p>\n<p>Neon will automatically branch your database for you after we set up the integration so don&#39;t worry about those.</p>\n<p>I personally set up a second Upstash, gave a fake Resend key for email, a second blob storage (which you can connect via the Storage tab but you do still need to add the <code>BLOB_BASE_URL</code> manually)</p>\n<p>For Neon Auth, it won&#39;t work as-is. This is somewhat intentional - Neon Auth today just has one environment that doesn&#39;t branch, so your preview env would be hitting production, which you may or may not want. I&#39;d say you probably don&#39;t want that.</p>\n<p>The way to work around this is to have a second Neon project that is just a Neon Auth project and you&#39;d regularly make a copy of your production Neon Auth to the project Neon Auth so it didn&#39;t fall out of sync (you&#39;d probably anonymize it too) - this isn&#39;t ideal and we&#39;re working on a better situation at Neon.</p>\n<p>Alternatively you could have your preview environments automatically add their redirect URLs on creation and then have a job to clean them up when they go away. Messy still too.</p>\n<p>Or, and hear me out here, you make the devs do it manually for each preview environment that needs it. Annoying, yes, but it also makes the devs handle it and it&#39;s not that burdensome to do - it&#39;s a couple of clicks in the Neon UI. We&#39;re going to skip doing this.</p>\n<p>Lastly I just add the AI_GATEWAY_KEY for all envs - it won&#39;t get used in test because I turned it off in test.</p>\n<blockquote>\n<p>üö® Be sure to not upload every step (like my repo is) - instead just upload the project you&#39;re working on.</p>\n</blockquote>\n<p>We don&#39;t need to modify the build or anything because it all should just be default Next.js - Vercel is very much built for Next.js and vice-versa.</p>\n<p>Once you&#39;ve done this, your app should be in prod! If you gave Vercel all the permissions it needed, it should also automatically set up all the Vercel preview deployment stuff with no additional work.</p>\n<p>Let&#39;s hook up everything we need now</p>\n<h2>Neon</h2>\n<p>Let&#39;s make Neon work. Vercel and Neon have taken great care to make sure this works really well together so experience is as easy as</p>\n<ul>\n<li>Go to the project dashboard</li>\n<li>Go to Settings</li>\n<li>Go to Integrations</li>\n<li>Browse Marketplace</li>\n<li>Search for and Click on Neon. <a href=\"https://vercel.com/marketplace/neon\">You can also go straight there from here</a></li>\n<li>Click Install from the top right, click Link Existing Neon Account since that&#39;s what we did.</li>\n<li>Link your existing project</li>\n</ul>\n<blockquote>\n<p>You can install Neon via Vercel. The only real difference here is that you&#39;ll get one bill for Neon through Vercel. Otherwise it&#39;s the same product doing the same thing.</p>\n</blockquote>\n<p>That&#39;s it! This will handle all secret management and branching for with regards to Vercel.</p>\n<h2>Neon Auth</h2>\n<p>Neon Auth won&#39;t work until you set the correct callback URL. You&#39;ll take your base Vercel URL which be something like <code>https://test-wiki-smoky.vercel.app/</code> and add that to Neon Auth&#39;s &quot;Trusted Domains&quot; under the configuration tab.</p>\n<p>For Neon Auth, it won&#39;t work as-is for the <em>preview environments</em>. This is somewhat intentional - Neon Auth today just has one environment that doesn&#39;t branch, so your preview env would be hitting production, which you may or may not want. I&#39;d say you probably don&#39;t want that.</p>\n<p>The way to work around this is to have a second Neon project that is just a Neon Auth project and you&#39;d regularly make a copy of your production Neon Auth to the project Neon Auth so it didn&#39;t fall out of sync (you&#39;d probably anonymize it too) - this isn&#39;t ideal and we&#39;re working on a better situation.</p>\n<p>Alternatively you could have your preview environments automatically add their redirect URLs on creation and then have a job to clean them up when they go away. Messy still too.</p>\n<p>Or, and hear me out here, you make the devs do it manually for each preview environment that needs it. Annoying, yes, but it also makes the devs handle it and it&#39;s not that burdensome to do - it&#39;s a couple of clicks in the Neon UI. We&#39;re going to skip doing this.</p>\n<h2>Upstash</h2>\n<p>Feel free to link up Upstash here as well, works the same way. I don&#39;t really <em>use</em> the integration that much - I think it has some novel behavior in Upstash&#39;s dashboard that can monitor different things. Really I just use it to make sure the environment variables stay in sync.</p>\n<h2>Resend</h2>\n<p>Same as above - this will just create a new API key on the fly and you can track Vercel usage individually. Fine to do or not do, as long as you have a Resend key.</p>\n<h2>Blob</h2>\n<p>Likewise here, via the Storage tab, you can create a link to your Vercel Storage account so that the UI links up nicely. Or you can just make sure the right variables are populated.</p>\n<blockquote>\n<p>For some of these, you may need to delete old keys that you put there first to set up the integrations. Vercel Blob is certainly that way (ask me how I know)</p>\n</blockquote>\n<p>If all of your variables are set, you should be able to see your site working!</p>\n","markdown":"We are going to now do all the fun DevOps parts at the end: we are going to deploy, we are going to do CI/CD, and we are going to do observability and analytics.\n\nThere are so many ways to skin this cat so we are going to keep it pretty focused - Vercel offers nearly all of these services built-in and it works really well with Neon and Upstash, so we're just going to lean on that. If I was just getting started, this is what I'd do - only reason I'd something like a different observability platform or analytics is if I outgrew the perfectly adequate offering on Vercel.\n\nGo to GitHub, create a new repo, and push your project into that repo. We're going to use this to deploy. Once you've pushed your code to GitHub, go to Vercel.com and create a new project and connect your GitHub so we can add your repo to this project.\n\nI took the liberty here of fixing some stuff up for deployment, namely adding a bunch of tests. This isn't a testing Next.js course and if you want to see my opinions on testing Next.js [check out my Intermediate React course][ir6] - I go into plenty depth there. So instead I just want you to see what to do with the tests once you have them. I've added some test specific code that you can look at if you want (for example it doesn't run the AI summaries in test because it'd waste a lot of tokens)\n\n> üèÅ This is the [09-with-tests][checkpoint] checkpoint. Open that folder in the sample project repo to go to where we are as of right here. This is the final version of the project and what we'll use to deploy.\n\nAnother note - these days I mostly vibe code my tests - it's such a perfect use case for it.\n\nIn this repo, it'll now expect _two_ sets of variables, if you want to. For the purposes of this course, feel free to just re-use your prod infra for test, but you'll see how to set up preview environments _and_ prod environments.\n\nNeon will automatically branch your database for you after we set up the integration so don't worry about those.\n\nI personally set up a second Upstash, gave a fake Resend key for email, a second blob storage (which you can connect via the Storage tab but you do still need to add the `BLOB_BASE_URL` manually)\n\nFor Neon Auth, it won't work as-is. This is somewhat intentional - Neon Auth today just has one environment that doesn't branch, so your preview env would be hitting production, which you may or may not want. I'd say you probably don't want that.\n\nThe way to work around this is to have a second Neon project that is just a Neon Auth project and you'd regularly make a copy of your production Neon Auth to the project Neon Auth so it didn't fall out of sync (you'd probably anonymize it too) - this isn't ideal and we're working on a better situation at Neon.\n\nAlternatively you could have your preview environments automatically add their redirect URLs on creation and then have a job to clean them up when they go away. Messy still too.\n\nOr, and hear me out here, you make the devs do it manually for each preview environment that needs it. Annoying, yes, but it also makes the devs handle it and it's not that burdensome to do - it's a couple of clicks in the Neon UI. We're going to skip doing this.\n\nLastly I just add the AI_GATEWAY_KEY for all envs - it won't get used in test because I turned it off in test.\n\n> üö® Be sure to not upload every step (like my repo is) - instead just upload the project you're working on.\n\nWe don't need to modify the build or anything because it all should just be default Next.js - Vercel is very much built for Next.js and vice-versa.\n\nOnce you've done this, your app should be in prod! If you gave Vercel all the permissions it needed, it should also automatically set up all the Vercel preview deployment stuff with no additional work.\n\nLet's hook up everything we need now\n\n## Neon\n\nLet's make Neon work. Vercel and Neon have taken great care to make sure this works really well together so experience is as easy as\n\n- Go to the project dashboard\n- Go to Settings\n- Go to Integrations\n- Browse Marketplace\n- Search for and Click on Neon. [You can also go straight there from here][neon]\n- Click Install from the top right, click Link Existing Neon Account since that's what we did.\n- Link your existing project\n\n> You can install Neon via Vercel. The only real difference here is that you'll get one bill for Neon through Vercel. Otherwise it's the same product doing the same thing.\n\nThat's it! This will handle all secret management and branching for with regards to Vercel.\n\n## Neon Auth\n\nNeon Auth won't work until you set the correct callback URL. You'll take your base Vercel URL which be something like `https://test-wiki-smoky.vercel.app/` and add that to Neon Auth's \"Trusted Domains\" under the configuration tab.\n\nFor Neon Auth, it won't work as-is for the _preview environments_. This is somewhat intentional - Neon Auth today just has one environment that doesn't branch, so your preview env would be hitting production, which you may or may not want. I'd say you probably don't want that.\n\nThe way to work around this is to have a second Neon project that is just a Neon Auth project and you'd regularly make a copy of your production Neon Auth to the project Neon Auth so it didn't fall out of sync (you'd probably anonymize it too) - this isn't ideal and we're working on a better situation.\n\nAlternatively you could have your preview environments automatically add their redirect URLs on creation and then have a job to clean them up when they go away. Messy still too.\n\nOr, and hear me out here, you make the devs do it manually for each preview environment that needs it. Annoying, yes, but it also makes the devs handle it and it's not that burdensome to do - it's a couple of clicks in the Neon UI. We're going to skip doing this.\n\n## Upstash\n\nFeel free to link up Upstash here as well, works the same way. I don't really _use_ the integration that much - I think it has some novel behavior in Upstash's dashboard that can monitor different things. Really I just use it to make sure the environment variables stay in sync.\n\n## Resend\n\nSame as above - this will just create a new API key on the fly and you can track Vercel usage individually. Fine to do or not do, as long as you have a Resend key.\n\n## Blob\n\nLikewise here, via the Storage tab, you can create a link to your Vercel Storage account so that the UI links up nicely. Or you can just make sure the right variables are populated.\n\n> For some of these, you may need to delete old keys that you put there first to set up the integrations. Vercel Blob is certainly that way (ask me how I know)\n\nIf all of your variables are set, you should be able to see your site working!\n\n[ir6]: https://holt.fyi/intermediate-react\n[checkpoint]: https://github.com/btholt/fullstack-next-wiki/tree/main/09-with-tests\n[neon]: https://vercel.com/marketplace/neon\n","slug":"deploy-to-vercel","title":"Deploy to Vercel","section":"DevOps","icon":"cogs","filePath":"/home/runner/work/build-a-fullstack-nextjs-app-v4/build-a-fullstack-nextjs-app-v4/lessons/09-devops/A-deploy-to-vercel.md","nextSlug":"/lessons/devops/speed-insights-analytics-and-observability","prevSlug":"/lessons/ai/cron"}},"__N_SSG":true}