{"pageProps":{"post":{"attributes":{},"html":"<p>Let&#39;s start with making the image uploads work. You can do this one of two ways with Vercel Blob (and many other storage solutions): directly from the client to Vercel, or from the client to your server to Vercel. The former skips the middleman and means your server doesn&#39;t have to know or care about image uploads which is nice. What happens is your server mints a temporary token that allows access to upload a file to Vercel and the clients send it there.</p>\n<p>Since we have all the server actions already set up, it&#39;s really easy for us to just do it via the server. What&#39;s advantageous about this is we could do any post-processing we wanted on the server too - resize, make thumbnails, etc. in this code which we wouldn&#39;t be able to do on the client. Both approaches work, we just went with the simpler one given our setup.</p>\n<p>In actions/upload.ts, put this</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-comment\">// at top</span>\n<span class=\"hljs-keyword\">import</span> { put } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;@vercel/blob&quot;</span>;\n\n<span class=\"hljs-comment\">// replace mock code</span>\n<span class=\"hljs-keyword\">try</span> {\n  <span class=\"hljs-keyword\">const</span> blob = <span class=\"hljs-keyword\">await</span> <span class=\"hljs-title function_\">put</span>(file.<span class=\"hljs-property\">name</span>, file, {\n    <span class=\"hljs-attr\">access</span>: <span class=\"hljs-string\">&quot;public&quot;</span>,\n    <span class=\"hljs-attr\">addRandomSuffix</span>: <span class=\"hljs-literal\">true</span>,\n  });\n\n  <span class=\"hljs-keyword\">return</span> {\n    <span class=\"hljs-attr\">url</span>: (blob <span class=\"hljs-keyword\">as</span> <span class=\"hljs-built_in\">any</span>).<span class=\"hljs-property\">url</span> ?? <span class=\"hljs-string\">&quot;&quot;</span>,\n    <span class=\"hljs-attr\">size</span>: file.<span class=\"hljs-property\">size</span>,\n    <span class=\"hljs-attr\">type</span>: file.<span class=\"hljs-property\">type</span>,\n    <span class=\"hljs-attr\">filename</span>: blobResult.<span class=\"hljs-property\">pathname</span> ?? file.<span class=\"hljs-property\">name</span>,\n  };\n} <span class=\"hljs-keyword\">catch</span> (err) {\n  <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">error</span>(<span class=\"hljs-string\">&quot;‚ùå Vercel Blob upload error:&quot;</span>, err);\n  <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Upload failed&quot;</span>);\n}\n</code></pre><ul>\n<li>Not too bad here. We upload an image to Vercel blob that we got via form data and get back an imageUrl that we save in the database.</li>\n<li><code>access: &quot;public&quot;</code> is essential as we want anyone to able to see these images.</li>\n<li><code>addRandomSuffix: true</code> is also important - if I upload <code>pic.jpg</code> and then you do with the same file name, it would overwrite it. But with this property set it&#39;s guaranteed to not collide.</li>\n<li>I already did all the validation that it&#39;s an image, not over 10MB, it&#39;s attached, etc. for you.</li>\n</ul>\n<p>Last thing, we need to save these images to the database and then make sure we select them for showing as well.</p>\n<p>In actions/articles.ts</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-comment\">// add to createArticle and updateArticle</span>\n<span class=\"hljs-attr\">imageUrl</span>: data.<span class=\"hljs-property\">imageUrl</span> ?? <span class=\"hljs-literal\">undefined</span>,\n</code></pre><p><code>??</code> is the nullish operation - if the first thing is falsey then it gives you the second thing. In this case if imageUrl is undefined, then it returns undefined. We could leave out the <code>?? undefined</code> but I feel like this is more clear.</p>\n<p>In lib/data/articles</p>\n<pre><code class=\"hljs language-typescript\"><span class=\"hljs-comment\">// add to getArticleById select</span>\n<span class=\"hljs-attr\">imageUrl</span>: articles.<span class=\"hljs-property\">imageUrl</span>,\n</code></pre><p>Now give it shot and see that it works!</p>\n<blockquote>\n<p>üèÅ This is the <a href=\"https://github.com/btholt/fullstack-next-wiki/tree/main/05-object-storage\">05-object-storage</a> checkpoint. Open that folder in the sample project repo to go to where we are as of right here.</p>\n</blockquote>\n","markdown":"Let's start with making the image uploads work. You can do this one of two ways with Vercel Blob (and many other storage solutions): directly from the client to Vercel, or from the client to your server to Vercel. The former skips the middleman and means your server doesn't have to know or care about image uploads which is nice. What happens is your server mints a temporary token that allows access to upload a file to Vercel and the clients send it there.\n\nSince we have all the server actions already set up, it's really easy for us to just do it via the server. What's advantageous about this is we could do any post-processing we wanted on the server too - resize, make thumbnails, etc. in this code which we wouldn't be able to do on the client. Both approaches work, we just went with the simpler one given our setup.\n\nIn actions/upload.ts, put this\n\n```typescript\n// at top\nimport { put } from \"@vercel/blob\";\n\n// replace mock code\ntry {\n  const blob = await put(file.name, file, {\n    access: \"public\",\n    addRandomSuffix: true,\n  });\n\n  return {\n    url: (blob as any).url ?? \"\",\n    size: file.size,\n    type: file.type,\n    filename: blobResult.pathname ?? file.name,\n  };\n} catch (err) {\n  console.error(\"‚ùå Vercel Blob upload error:\", err);\n  throw new Error(\"Upload failed\");\n}\n```\n\n- Not too bad here. We upload an image to Vercel blob that we got via form data and get back an imageUrl that we save in the database.\n- `access: \"public\"` is essential as we want anyone to able to see these images.\n- `addRandomSuffix: true` is also important - if I upload `pic.jpg` and then you do with the same file name, it would overwrite it. But with this property set it's guaranteed to not collide.\n- I already did all the validation that it's an image, not over 10MB, it's attached, etc. for you.\n\nLast thing, we need to save these images to the database and then make sure we select them for showing as well.\n\nIn actions/articles.ts\n\n```typescript\n// add to createArticle and updateArticle\nimageUrl: data.imageUrl ?? undefined,\n```\n\n`??` is the nullish operation - if the first thing is falsey then it gives you the second thing. In this case if imageUrl is undefined, then it returns undefined. We could leave out the `?? undefined` but I feel like this is more clear.\n\nIn lib/data/articles\n\n```typescript\n// add to getArticleById select\nimageUrl: articles.imageUrl,\n```\n\nNow give it shot and see that it works!\n\n> üèÅ This is the [05-object-storage][checkpoint] checkpoint. Open that folder in the sample project repo to go to where we are as of right here.\n\n[checkpoint]: https://github.com/btholt/fullstack-next-wiki/tree/main/05-object-storage\n","slug":"upload-images","title":"Upload Images","section":"Object Storage","icon":"cloud","filePath":"/home/runner/work/build-a-fullstack-nextjs-app-v4/build-a-fullstack-nextjs-app-v4/lessons/05-object-storage/B-upload-images.md","nextSlug":"/lessons/key-value-store/upstash","prevSlug":"/lessons/object-storage/vercel-blob"}},"__N_SSG":true}